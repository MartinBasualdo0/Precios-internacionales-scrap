---
title: "Precios internacionales"
author: "INDEC"
date: "2/3/2022"
output: html_document
---
## Trigo

Entrar a [Agrofy](https://news.agrofy.com.ar/granos/series-historicas-pizarra), donde se encuentran los precios de trigo a valor fob en los principales puertos. El más representativo es el de la bolsa de rosario. 

Pasos:

* Fecha: ir a mano hasta el 2010. La flecha izquierda tiene que tocarse tantas veces como meses existan de diferencia entre el período base (1/1/2010) hasta la fecha. 

* Materia prima: seleccionar trigo. 

* Bolsa: Rosario.

* Moneda: Dolar. 

* Click en buscar

* Descargar la tabla completa. Ver si se puede hacer de una, y no necesariamente viendo las 75 páginas por selenium.

* Hacer lo mismo con el maíz, soja, girasol, y sorgo. 

Una vez extraídos los datos, tengo que hacer una media mensual. 

# Scrap

```{r configura, echo=T, message=FALSE, warning=FALSE, results='hide'}
setwd("./instalacion selenium r") # Inserir caminho
system("java -jar selenium-server-standalone-4.0.0-alpha-1.jar", wait = FALSE) # Declara selenium
system("chromedriver.exe", wait = FALSE) # Declara chromedriver
```
```{r librerías, echo=T, message=FALSE, warning=FALSE, results='hide'}
library(RSelenium)
library(tidyverse)
library(lubridate)
library(rvest)
library(glue)
```
```{r abrir_navegador, echo = T, results = 'hide'}
link = "https://news.agrofy.com.ar/granos/series-historicas-pizarra"

eCaps <- list(
  chromeOptions = 
    list(prefs = list("profile.default_content_settings.popups" = 0L,
"download.prompt_for_download" = FALSE,
"directory_upgrade" = TRUE,
"download.default_directory" = getwd())
  )
)


driver <- remoteDriver(remoteServerAddr = "localhost", 
                      browserName = "chrome",
                      extraCapabilities = eCaps) # Inicia o driver
driver$open() # Abre navegador/browser
driver$navigate(link) # Navega pelo link
driver$maxWindowSize() # Maximiza a janela do navegador
```


Se cierra solo en 6 segundos aprox. 


Abrimos el calendario para elegir el inicio del periodo a consultar
```{r}
Sys.sleep(10)

date_pickers <- driver$findElements(using = 'css',
                                   value = '.react-datepicker__input-container')
since_date_picker <- date_pickers[[1]]
to_date_picker<- date_pickers[[2]] 


since_date_picker$clickElement() #abre datepicker que selecciona inicio de consulta
```
Ahora tenemos que crear una funcion que, dada una fecha, la elija en el datepicker

```{r}
auto_datepicker <- function(desde){
  # Elige la fecha automáticamente a partir de lo que pasamos como parámtero
  #primero debemos saber la fecha de hoy y asi saber como nos tenemos que mover ene eldatepicker
  desde <- as.Date(desde)
  hoy <- today()

  dif_de_meses <- length(seq(from=desde, to=hoy, by='month')) - 1
  
  for (n in 1:dif_de_meses){
    #selecciona la flecha de mes
    boton_mes_anterior <- driver$findElement(using = 'css',
                                  value='.react-datepicker__navigation--previous')
    boton_mes_anterior$clickElement()
  }
  dia_uno <- driver$findElement(using = 'css',
                                  value='.react-datepicker__day--001')
  dia_uno$clickElement()
  
}
```



```{r}
auto_datepicker('2010-01-01')
```
### Producto, mercado, moneda
```{r}
producto_mercado_dropdown <- driver$findElements(using = 'css',
                                   value = '.dropdown-heading-value')
producto_dropdown <- producto_mercado_dropdown[[1]]
mercado_dropdown<- producto_mercado_dropdown[[2]] 

producto_dropdown$clickElement()


producto_todos <- driver$findElement(using = 'css', #Un solo elemento
                                   value = '.select-item')
producto_todos$clickElement()

mercado_dropdown$clickElement()
mercado_todos <- driver$findElement(using = 'css', #Un solo elemento
                                   value = '.select-item')
mercado_todos$clickElement()

moneda_dropdown <- driver$findElement(using = 'css',
                                   value = '#currency')
moneda_dropdown$clickElement()

moneda_option <- driver$findElements(using = 'css',
                                   value = '.option')
moneda_option[[2]]$clickElement()
```
Buscamos la wea

```{r}
buscar <- driver$findElements(using = 'css',
                                   value = '.btn-primary')
buscar[[length(buscar)]]$clickElement()

Sys.sleep(60) #55 en realiad, pero prefiero darle paso
```


```{r}
export_csv_button <- driver$findElement(using = 'css',
                                   value = '.csv-export')
export_csv_button$clickElement()

```


